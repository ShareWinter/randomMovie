---
name: 完善房间功能
overview: 完善房间逻辑，包括房间号复制、退出房间、断连自动离开、影片选择机制优化
todos:
  - id: room-code-copy
    content: 添加房间号点击复制功能
    status: completed
  - id: leave-room-btn
    content: 添加退出房间按钮和逻辑
    status: completed
    dependencies:
      - room-code-copy
  - id: disconnect-leave
    content: 实现断开连接自动离开房间
    status: completed
    dependencies:
      - leave-room-btn
  - id: movie-pool-merge
    content: 优化影片选择机制，支持多人贡献影片池
    status: completed
    dependencies:
      - disconnect-leave
---

## 产品概述

完善房间整体逻辑，包括加入/退出、参与者同步、影片选择机制、房间号复制功能

## 核心功能

- **房间号点击复制**：房间号可点击复制到剪贴板
- **用户主动退出房间**：添加退出房间按钮，退出后同步更新参与者列表
- **断开连接自动离开**：Socket断开时自动从房间移除用户
- **影片选择机制**：支持所有参与者选择影片，合并到共享抽奖池

## 技术方案

### 1. 房间号点击复制

在房间页面标题处添加点击复制功能，使用 `navigator.clipboard.writeText` API

### 2. 用户主动退出房间

- 在房间页面添加"退出房间"按钮
- 调用 socket emit `leave-room` 事件
- 退出后跳转回首页

### 3. 断开连接自动离开

- 在 server.ts 的 disconnect 事件中处理用户离开房间
- 需要维护 socketId 到用户/房间的映射
- 断开时从数据库移除用户并广播更新

### 4. 影片选择机制优化

- 将 `movieList` 改为按用户分组的结构 `{ userId, movieIds }`
- 或维护每个用户的影片选择，前端合并显示所有参与者选择的影片
- 房间页面显示所有参与者贡献的影片池

### 涉及文件

- `src/app/(main)/room/[code]/page.tsx` - 添加复制、退出功能
- `socket/roomHandler.ts` - 处理退出、断开连接、影片选择合并
- `server.ts` - 断开连接处理
- `src/models/Room.ts` - 可能需要调整 movieList 结构