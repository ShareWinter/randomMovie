---
name: 电影数据结构升级与片单批量添加
overview: 修改电影数据结构添加主演和豆瓣链接字段，处理海报webp格式转换，新增豆瓣片单批量添加功能
todos:
  - id: modify-model
    content: 修改 Movie 模型和类型定义，添加 cast 和 doubanUrl 字段
    status: pending
  - id: update-wmdb-api
    content: 更新 wmdbApi.ts，处理海报 webp 转换，返回 doubanUrl
    status: pending
    dependencies:
      - modify-model
  - id: create-doulist-api
    content: 创建片单批量爬取 API 路由
    status: pending
    dependencies:
      - update-wmdb-api
  - id: update-add-form
    content: 更新 AddMovieForm 组件，新增片单批量添加模式
    status: pending
    dependencies:
      - create-doulist-api
  - id: update-detail-modal
    content: 更新 MovieDetailModal 组件，显示主演和豆瓣链接
    status: pending
    dependencies:
      - modify-model
---

## 产品概述

扩展现有影片管理功能，支持更完整的影片信息展示和豆瓣片单批量添加。

## 核心功能

1. **影片数据结构扩展**

- 新增 `cast`（主演）字段：字符串数组，存储主演列表
- 新增 `doubanUrl`（豆瓣链接）字段：存储影片豆瓣详情页链接
- 展示信息：名字、海报、年份、导演、主演、类型、制片国家/地区、豆瓣评分

2. **海报处理优化**

- 检测海报 URL 后缀，非 .webp 格式自动转换为 .webp
- 片单批量添加时，海报请求需带 referer 和 user-agent 头

3. **豆瓣片单批量添加**

- 新增片单链接输入模式，支持格式如 `https://www.douban.com/doulist/163511051/`
- 从片单 HTML 解析影片列表：标题、海报、评分、导演、主演、类型、地区、年份
- 批量添加到用户影片库

4. **保留现有功能**

- 保持豆瓣单部影片链接添加方式不变
- 仅扩展存储结构和展示内容

## 技术栈

- 后端：Next.js API Routes + Mongoose
- 前端：React + TypeScript + Tailwind CSS
- 数据爬取：原生 fetch + HTML 解析（片单）

## 实现方案

### 1. 数据模型修改

扩展 Movie Schema，添加新字段：

- `cast: [String]` - 主演列表
- `doubanUrl: String` - 豆瓣影片链接

### 2. 海报处理逻辑

```typescript
// 转换海报为 webp 格式
function convertToWebp(posterUrl: string): string {
  if (!posterUrl) return ''
  // 豆瓣图片 URL 格式: https://img1.doubanio.com/view/photo/s_ratio_poster/public/p2575337180.jpg
  return posterUrl.replace(/\.(jpg|png|gif)$/i, '.webp')
}
```

### 3. 片单批量爬取

创建新 API 路由 `/api/movies/scrape-doulist`：

- 获取片单 HTML 页面
- 使用正则解析影片信息
- 批量请求影片详情（使用 wmdb API）
- 海报请求带 referer 和 user-agent 头

### 4. 前端表单扩展

AddMovieForm 新增三种模式：

- 豆瓣单部链接（保留）
- 豆瓣片单链接（新增）
- 手动添加（保留）

## 目录结构

```
src/
├── models/Movie.ts                    # [MODIFY] 添加 cast、doubanUrl 字段
├── types/index.ts                     # [MODIFY] 同步更新类型定义
├── lib/wmdbApi.ts                     # [MODIFY] 返回 doubanUrl，处理海报 webp 转换
├── app/api/movies/
│   ├── scrape/route.ts                # [MODIFY] 处理海报 webp 转换
│   └── scrape-doulist/route.ts        # [NEW] 片单批量爬取 API
├── components/movie/
│   ├── AddMovieForm.tsx               # [MODIFY] 新增片单添加模式
│   └── MovieDetailModal.tsx           # [MODIFY] 显示主演和豆瓣链接
```

## 实现细节

- 片单海报需要后端代理请求，因为豆瓣有防盗链
- 主演信息从 wmdb API 获取（如果有）或从片单 HTML 解析
- 批量添加时显示进度，避免用户等待焦虑